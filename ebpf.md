## 2025-07-17 
## 01 aya-tool ç”Ÿæˆçš„ vmlinux.rs

### ğŸ§© ä¸€ã€aya-tool ç”Ÿæˆçš„ vmlinux.rs å¯ä»¥ä¿®æ”¹å—ï¼Ÿ
**âœ… å¯ä»¥ä¿®æ”¹ï¼Œä½†ä¸€èˆ¬ä¸å»ºè®®æ‰‹åŠ¨ä¿®æ”¹åŸå§‹æ–‡ä»¶ã€‚**
**ä¸ºä»€ä¹ˆï¼Ÿ**
- aya-toolï¼ˆæˆ– cargo xtask generateï¼‰æ˜¯åŸºäº BTF è‡ªåŠ¨ç”Ÿæˆ vmlinux.rsï¼Œä¸‹ä¸€æ¬¡è¿è¡Œ generate ä¼šå®Œå…¨è¦†ç›–ä½ åšçš„æ‰‹åŠ¨æ›´æ”¹ã€‚

- ä½ ä¿®æ”¹çš„æ˜¯ä¸€ä¸ªæœºå™¨ç”Ÿæˆçš„ç»“æ„å®šä¹‰æ–‡ä»¶ï¼Œå’Œå†…æ ¸ ABI å¼ºç»‘å®šï¼Œæ‰‹æ”¹å®¹æ˜“é€ æˆï¼š

    - å­—æ®µåç§»ä¸å¯¹é½

    - ç±»å‹é”™é…

    - panic æˆ– undefined behavior

**ğŸ§­ æ­£ç¡®åšæ³•ï¼ˆå»ºè®®ï¼‰ï¼š**

**âœ… ä¸è¦ç›´æ¥æ”¹ vmlinux.rsï¼Œè€Œæ˜¯ï¼š**
- **âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ç»“æ„ä½“ï¼ˆæ¨èï¼‰**

è‡ªå·±åœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª my_task_struct.rsï¼Œåªå¤åˆ¶ä½ å…³å¿ƒçš„å­—æ®µï¼Œæ¯”å¦‚ï¼š

```rust
#[repr(C)]
pub struct MyTaskStruct {
    pub pid: u32,
    pub comm: [u8; 16],
    // åªå…³å¿ƒä½ è¦ trace çš„å­—æ®µ
}
```
ç„¶åç”¨ BPF çš„ unsafe æŒ‡é’ˆåç§»æ–¹å¼ä»åŸå§‹ task_struct æ‹¿åˆ°å­—æ®µã€‚

- **âœ… æ–¹å¼äºŒï¼šç”¨ aya-tool ç”Ÿæˆåï¼Œåœ¨è‡ªåŠ¨ç”ŸæˆåŒºåŸŸä¹‹å¤–æ‰©å±• wrapper**
```rust
mod vmlinux {
    include!("vmlinux.rs");
}

pub struct MyWrapper {
    pub task: vmlinux::task_struct,
    // ä½ å¯ä»¥åœ¨ wrapper ä¸­åŠ è¾…åŠ©é€»è¾‘
}
```

### ğŸ› ï¸ äºŒã€ä»€ä¹ˆæƒ…å†µä¼šä¿®æ”¹ vmlinux.rsï¼Ÿ
åœ¨ä¸€äº›é«˜çº§åœºæ™¯ä¸‹ï¼Œä»¥ä¸‹ä¿®æ”¹æ˜¯æœ‰æ„ä¸ºä¹‹ï¼š

**âœ… åˆç†ä¿®æ”¹åœºæ™¯åŒ…æ‹¬ï¼š**

| ä¿®æ”¹å†…å®¹      | ç›®çš„ |
| ----------- | ----------- |
| åˆ é™¤ä¸å¿…è¦çš„ç»“æ„ä½“ |	å‡å°ç¼–è¯‘æ—¶é—´ã€å‡å° ELF ä½“ç§¯ |
| åˆ é™¤æŸäº›å­—æ®µ	| è§„é¿ç¼–è¯‘å™¨å¯¹å¤æ‚ union / padding çš„æŠ±æ€¨ |
|æ‰‹åŠ¨æ·»åŠ  #[derive(Debug)] |	ä¸ºäº†è°ƒè¯•æ‰“å°ç»“æ„ä½“ |
|ä¿®æ”¹å­—æ®µåï¼ˆå¦‚ __bindgen_padding_1ï¼‰|	æ›´æ˜“è¯»ï¼Œä½†å¯èƒ½å‡ºé”™ |
|åˆ é™¤ __bindgen_padding_...	| è®©ä»£ç æ›´ç®€æ´ï¼Œä½†ä¸å»ºè®® |

âš ï¸ è¯·ç¡®ä¿ä½ ç†è§£ç»“æ„ä½“å¯¹é½ä¸å†…æ ¸ BTF æ˜ å°„ï¼Œå¦åˆ™å»ºè®®ä¸æ”¹ã€‚

### ğŸ“¦ ä¸‰ã€ä¸ºä»€ä¹ˆä¸åŒé¡¹ç›®ç”Ÿæˆçš„ vmlinux.rs æ–‡ä»¶å¤§å°ä¸ä¸€æ ·ï¼Ÿ


**âœ… å¤§å°ä¸ä¸€è‡´çš„æ ¹æœ¬åŸå› ï¼š**

| å·®å¼‚æ¥æº	| è¯´æ˜ |
| -------- |-----|
|âœ… å†…æ ¸ç‰ˆæœ¬ä¸åŒ	| BTF æ˜¯é’ˆå¯¹æ¯ä¸ª Linux å†…æ ¸æ„å»ºçš„ï¼Œå­—æ®µ/ç»“æ„æ•°é‡å¯èƒ½ä¸åŒï¼ˆæ¯”å¦‚ 5.10 vs 6.1ï¼‰|
|âœ… ä½¿ç”¨çš„ bpftool ä¸åŒ	| æ–°ç‰ˆ bpftool ä¼šä¿ç•™æ›´å¤šç±»å‹æˆ–åˆ«åç»“æ„ä½“ |
|âœ… aya-tool çš„é…ç½®ä¸åŒ	| ä½ å¯èƒ½æŒ‡å®šäº†ä¸åŒ --type task_struct æˆ–æ— é™åˆ¶ç”Ÿæˆå…¨éƒ¨ç±»å‹ |
|âœ… è£å‰ªä¼˜åŒ–ä¸åŒ	 | æœ‰çš„é¡¹ç›®ä½¿ç”¨ bindgen å‚æ•°è£å‰ªä¸å¿…è¦çš„ç±»å‹ï¼Œå¦ä¸€äº›åˆ™å…¨é‡ç”Ÿæˆ |
|âœ… è‡ªåŠ¨æ¸…ç†æ— ç”¨ç»“æ„ä½“ï¼ˆæ–°ç‰ˆæœ¬ aya-toolï¼‰|	æŸäº›ç‰ˆæœ¬ä¼šåˆ é™¤æœªè¢«å¼•ç”¨çš„ç»“æ„ä½“ï¼Œæœ‰çš„ä¸ä¼š |

**ğŸ“Œ å¦‚ä½•åªç”Ÿæˆè‡ªå·±æƒ³è¦çš„ç»“æ„ä½“ï¼ˆæ¨èï¼‰ï¼Ÿ**
å¦‚æœä½ åªå…³å¿ƒ task_struct å’Œ credï¼Œä½ å¯ä»¥ï¼š

```bash
aya-tool generate \
  --btf /sys/kernel/btf/vmlinux \
  --type task_struct \
  --type cred \
  > src/vmlinux.rs
```
è¿™æ ·ç”Ÿæˆçš„æ–‡ä»¶ä¼šéå¸¸å°ï¼ŒåªåŒ…å«ä½ æŒ‡å®šçš„ç»“æ„ä½“åŠä¾èµ–ã€‚

**âœ… æ€»ç»“**

|é—®é¢˜	| è§£ç­” |
|------|-----|
| vmlinux.rs å¯ä»¥ä¿®æ”¹å—ï¼Ÿ|	å¯ä»¥ï¼Œä½†ä¸æ¨èç›´æ¥æ”¹ï¼›æ›´æ¨èåŒ…è£…æˆ–é‡å®šä¹‰å…³é”®ç»“æ„ |
|ä¿®æ”¹æœ‰ä»€ä¹ˆé£é™©ï¼Ÿ	| è¢«é‡å†™ã€å­—æ®µåç§»é”™é…ã€ç¼–è¯‘å¤±è´¥ã€è¿è¡Œé”™è¯¯ |
|å¦‚ä½•æ­£ç¡®ä¿®æ”¹ï¼Ÿ|	è‡ªå·±å®šä¹‰ repr(C) ç»“æ„ä½“ï¼Œåªé€‰ç”¨å…³å¿ƒçš„å­—æ®µ |
| ä¸¤ä¸ªé¡¹ç›®ç”Ÿæˆçš„æ–‡ä»¶ä¸ºä½•ä¸ä¸€æ ·ï¼Ÿ	|ç”±äºå†…æ ¸ç‰ˆæœ¬ã€btf å†…å®¹ã€aya-tool å‚æ•°ã€æ˜¯å¦è£å‰ªç±»å‹ç­‰ä¸åŒ |



## 02 eBPF LSM å’Œ  AppArmorã€SELinuxã€Smack å’Œ TOMOYOç­‰å¯¹æ¯”

### ğŸ§© æ€»è§ˆå¯¹æ¯”è¡¨
|ç‰¹æ€§/æ¨¡å—	|eBPF LSM	|SELinux	|AppArmor	|TOMOYO	 |Smack |
|---------|-----------|-----------|-----------|--------|------|
|â›“ï¸ å¼ºåˆ¶è®¿é—®æ§åˆ¶ (MAC)	|âœ… æ˜¯ï¼Œå¯å®ç°å®Œæ•´ LSM	|âœ… æ˜¯ï¼Œå…¨é¢	|âœ… æ˜¯ï¼Œè·¯å¾„/ç¨‹åºçº§åˆ«æ§åˆ¶	|âœ… æ˜¯ï¼Œè¿‡ç¨‹è·¯å¾„æ§åˆ¶	|âœ… æ˜¯ï¼Œæ ‡ç­¾ç³»ç»Ÿ |
|âš™ï¸ å®ç°æ–¹å¼ |	ä½¿ç”¨ eBPF ç¨‹åºæŒ‚åœ¨ LSM hook ä¸Š |	C å†…æ ¸æ¨¡å— + ç­–ç•¥|	å†…æ ¸æ¨¡å— + ç”¨æˆ·æ€é…ç½®æ–‡ä»¶ |	å†…æ ¸æ¨¡å— + å­¦ä¹ æ¨¡å¼ |	å†…æ ¸æ¨¡å— + ç®€å•ç­–ç•¥ç³»ç»Ÿ |
| ğŸ“¦ ç”¨æˆ·æ€ä¾èµ–	| æœ€å°‘ï¼ˆå¯ä»¥å†…åµŒç­–ç•¥ï¼‰	| éœ€è¦å®Œæ•´çš„ç­–ç•¥æ–‡ä»¶ç³»ç»Ÿ	| éœ€è¦ profile æ–‡ä»¶	| éœ€è¦é…ç½®æ–‡ä»¶ï¼Œå­¦ä¹ è·¯å¾„è®°å½•	| ç®€å•çš„æ ‡ç­¾æ–‡ä»¶| 
| ğŸ§  çµæ´»æ€§/å¯ç¼–ç¨‹æ€§	| âœ… æé«˜ï¼Œè‡ªå®šä¹‰ä»»æ„ hook å’Œé€»è¾‘	| âŒ å›ºå®šç­–ç•¥è¯­è¨€	| âŒ ç›¸å¯¹ç®€å•ï¼ˆProfile é™å®šï¼‰	| âŒ æœ‰é™åˆ¶	| âŒ éç¨‹åºåŒ–ï¼Œå›ºå®šç­–ç•¥| 
| ğŸ’¡ åŠ¨æ€æ€§/çƒ­æ›´æ–° |	âœ… å¯çƒ­åŠ è½½ eBPFï¼Œæ— éœ€é‡å¯	| âŒ ä¿®æ”¹ç­–ç•¥éœ€é‡å¯æˆ– reload	| âœ… å¯ reload	| âœ… å¯ reload	| âŒ åŸºæœ¬éœ€é‡å¯ç­–ç•¥ç³»ç»Ÿ| 
| ğŸ§ª å®‰å…¨ç²’åº¦	| âœ… ä»»æ„ç²¾åº¦ï¼ˆå‡½æ•°ã€è·¯å¾„ã€UIDï¼‰	| âœ… éå¸¸é«˜ï¼ˆç±»å‹/åŸŸï¼‰	| ä¸­ç­‰ï¼ˆè·¯å¾„ã€ç¨‹åºã€capï¼‰	| ä¸­ç­‰	| è¾ƒä½| 
| ğŸ‘· ç”¨æˆ·å­¦ä¹ æˆæœ¬	| é«˜ï¼ˆéœ€è¦æ‡‚ eBPFï¼‰	| æé«˜ï¼ˆå¤æ‚ç­–ç•¥è¯­è¨€ï¼‰	| ä¸­ç­‰ï¼ˆæ–‡ä»¶è·¯å¾„ + æƒé™ï¼‰	| ä¸­ç­‰ï¼ˆé…ç½®ç›´è§‚ï¼‰	| ä½| 
| ğŸ“ˆ æ€§èƒ½	| å¾ˆé«˜ï¼Œè¿‘åŸç”Ÿï¼Œçµæ´»ä¼˜åŒ–	| é«˜ï¼ˆä½†ç•¥ä½äº eBPFï¼‰	| é«˜	| é«˜	| é«˜| 
| ğŸ§ª å®¡è®¡æ”¯æŒ	| âœ… å¯è‡ªå®šä¹‰æ—¥å¿—	| âœ… SELinux Audit	| âœ… AppArmor Audit	| âŒ è¾ƒå¼±	| âŒ è¾ƒå¼±| 
| ğŸ¯ åº”ç”¨åœºæ™¯	| äº‘åŸç”Ÿã€ç‰¹å®šæœåŠ¡å®‰å…¨ã€ç»†ç²’åº¦æ§åˆ¶	| æ”¿åºœã€é‡‘èã€å¤§å‹ä¼ä¸š	| æ¡Œé¢/æœåŠ¡å™¨é€šç”¨è½»é‡çº§éš”ç¦»	| å®šåˆ¶å°å‹ç³»ç»Ÿ	| ç®€å•å¼ºåˆ¶ç­–ç•¥ï¼ˆIoTï¼‰| 

### ğŸ§¬ 1. ä»€ä¹ˆæ˜¯ eBPF LSMï¼Ÿ
eBPF LSM æ˜¯å°† eBPF ç¨‹åºæŒ‚è½½åˆ° LSM hook ç‚¹ çš„èƒ½åŠ›ï¼Œé¦–æ¬¡å¼•å…¥äº Linux 5.7ï¼Œåœ¨ Linux 5.13 åå®Œå…¨ä¸»çº¿æ”¯æŒã€‚

å®ƒå…è®¸ç”¨æˆ·ç¼–å†™è‡ªå®šä¹‰çš„å®‰å…¨é€»è¾‘å¹¶ attach åˆ°å†…æ ¸å®‰å…¨é’©å­ä¸Šï¼Œå¦‚ï¼š

```rust
#[lsm_hook]
fn bpf_file_open(file: *const File, cred: *const Cred) -> i32 {
    if bpf_current_uid() == 0 {
        return -1; // é˜»æ­¢ root æ‰“å¼€æ–‡ä»¶
    }
    0
}
```
è¿™ç±»ç¨‹åºåœ¨ å†…æ ¸äº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œï¼Œç”¨äºå®¡è®¡ã€æ§åˆ¶ã€æ‹’ç»ç­‰ã€‚

### ğŸ” 2. ä¸ä¼ ç»Ÿ LSM çš„æ ¸å¿ƒåŒºåˆ«

| é¡¹ç›®	| ä¼ ç»Ÿ LSMï¼ˆSELinux, AppArmor ç­‰ï¼‰	| eBPF LSM| 
| ----- | ---- | -----| 
| å®‰å…¨ç­–ç•¥	| é…ç½®æ–‡ä»¶ + ç¼–è¯‘ç­–ç•¥è¯­è¨€	| eBPF ç¨‹åº| 
| æ›´æ–°æ–¹å¼	| ä¿®æ”¹åéœ€ | reloadã€å¯èƒ½é‡å¯	| åŠ¨æ€åŠ è½½ã€çƒ­æ›´æ–°| 
| ç²’åº¦	| é™æ€ç­–ç•¥çº§åˆ«ï¼ˆè·¯å¾„/ç±»å‹ï¼‰	| ä»»æ„ä¸Šä¸‹æ–‡ï¼ˆPIDã€UIDã€pathã€å‚æ•°å†…å®¹ï¼‰| 
| å¯ç»„åˆæ€§	| å¤š LSM ç»„åˆå—é™ï¼ˆä»…éƒ¨åˆ†æ¨¡å—ï¼‰	| ä½œä¸º stacked LSM æ’ä»¶| 

### ğŸ¯ 3. é€‚ç”¨åœºæ™¯å¯¹æ¯”
| åœºæ™¯	| å»ºè®®æ¨¡å—| 
| --- | ---| 
| ğŸ›ï¸ ä¼ä¸šæœåŠ¡å™¨ï¼ˆå¦‚ RHELï¼‰	| SELinuxï¼ˆæ”¿åºœçº§å®‰å…¨ï¼‰| 
| ğŸ–¥ï¸ æ¡Œé¢ç³»ç»Ÿ	| AppArmorï¼ˆUbuntu é»˜è®¤ï¼‰| 
| ğŸš€ äº‘åŸç”Ÿã€Kubernetes	| eBPF LSMï¼ˆçµæ´»ã€çƒ­æ’æ‹”ï¼‰| 
| ğŸ”§ IoT åµŒå…¥å¼ç³»ç»Ÿ	| Smack / TOMOYOï¼ˆè½»é‡ï¼‰| 
| ğŸ§ª å®‰å…¨ç ”ç©¶/å®šåˆ¶ç›‘æ§	| eBPF LSMï¼ˆHook çº§åˆ«æ§åˆ¶ï¼‰| 

### âš ï¸ 4. å¤š LSM å…±å­˜é—®é¢˜

Linux æ”¯æŒ Stacked LSMï¼Œå…è®¸å¤šä¸ª LSM å¹¶å­˜ï¼Œä½†ï¼š

- **SELinux å’Œ AppArmor é€šå¸¸ä¸èƒ½å…±å­˜**

- **eBPF LSM æ˜¯ä½œä¸º secondary module æ’å…¥ï¼Œé€šå¸¸å¯ä»¥å’Œç°æœ‰ LSM å…±å­˜ï¼ˆéé»˜è®¤ deny-onlyï¼‰**

### ğŸ›¡ï¸ 5. å¼€å‘æˆæœ¬å’Œéš¾åº¦
| æ¨¡å—	| å¼€å‘æ–¹å¼	| å­¦ä¹ éš¾åº¦| 
| --| --| --| 
| SELinux	| å†™ç­–ç•¥ã€ä½¿ç”¨ semanage, audit2allow	| æé«˜| 
| AppArmor	| å†™ profileï¼Œç®€å•è§„åˆ™	| ä¸­ç­‰| 
| eBPF LSM	| å†™ Rust/C eBPFï¼Œç†è§£å†…æ ¸ Hook ç‚¹	| é«˜| 
| Smack / TOMOYO	| å†™ç®€å•é…ç½®	| ä¸­ä½| 

### ğŸ§  å°ç»“ï¼šä½ è¯¥é€‰æ‹©å“ªä¸ªï¼Ÿ
| è§’è‰²	| æ¨èé€‰æ‹©| 
| --| --| 
| å®‰å…¨ç ”ç©¶è€…	| eBPF LSMï¼šçµæ´»ã€é«˜ç²’åº¦ã€æ˜“å®éªŒ| 
| ä¼ä¸šå®‰å…¨å·¥ç¨‹å¸ˆ	| SELinuxï¼šæ”¿åºœåˆè§„ã€é›†ä¸­ç­–ç•¥| 
| äº‘å®‰å…¨å·¥ç¨‹å¸ˆ	| eBPF LSM + AppArmorï¼ˆç»„åˆçµæ´»ï¼‰| 
| æ¡Œé¢å‘è¡Œç‰ˆå¼€å‘è€…	| AppArmorï¼šè½»ä¾¿ã€ç”¨æˆ·æ˜“ç”¨| 
| IoT ç³»ç»Ÿå·¥ç¨‹å¸ˆ| 	Smack / TOMOYOï¼šè¶…è½»é‡| 



## 03 LSM è§„åˆ™ï¼ˆhooksï¼‰

ä¸‹é¢æ˜¯ä¸€ä¸ªå…¨é¢çš„ Linux å®‰å…¨æ¨¡å—ï¼ˆLSM, Linux Security Modulesï¼‰çš„ è§„åˆ™ï¼ˆhooksï¼‰ä½“ç³»æ€»è§ˆï¼ŒåŒ…æ‹¬ï¼š

- å†…æ ¸ä¸­å¯ä¾› LSM æ¨¡å—æŒ‚é’©çš„å…¨éƒ¨ hook ç‚¹ï¼ˆlsm_hooksï¼‰

- å„æ¨¡å—ï¼ˆSELinux / AppArmor / eBPF LSM / Smack / TOMOYOï¼‰é€šå¸¸ä½¿ç”¨çš„è§„åˆ™ç±»åˆ«

- è¦†ç›–æ–‡ä»¶ã€è¿›ç¨‹ã€ç½‘ç»œã€IPCã€æ¨¡å—ã€å†…å­˜ç­‰å„ä¸ªç»´åº¦

- é€‚åˆå®‰å…¨ç­–ç•¥å¼€å‘ã€eBPF-LSM æ’æ¡©ç‚¹é€‰æ‹©ã€å¯¹æ¯”ç†è§£

### ğŸ§© 1. LSM Hook ç‚¹ï¼ˆè§„åˆ™ç±»å‹ï¼‰æ€»è§ˆ

Linux å†…æ ¸é€šè¿‡ security/security.c å…¬å¼€äº†å¤§é‡ LSM hook ç‚¹ï¼Œåˆ†ä¸ºä»¥ä¸‹å¤§ç±»ï¼š

| ç±»å‹	| ç¤ºä¾‹ Hook å‡½æ•°	| ç”¨é€”| 
| -- | -- | -- | 
| è¿›ç¨‹æ§åˆ¶	| security_bprm_check, task_kill, ptrace_access_check	| æ§åˆ¶è¿›ç¨‹æ‰§è¡Œã€ä¿¡å·å‘é€ã€è°ƒè¯•æƒé™ç­‰| 
| æ–‡ä»¶æ“ä½œ	| inode_permission, file_open, file_ioctl	| æ§åˆ¶æ–‡ä»¶æ‰“å¼€ã€è®¿é—®ã€æƒé™æ£€æŸ¥ç­‰| 
| ç½‘ç»œæ“ä½œ	| socket_create, socket_connect, socket_sendmsg	| é™åˆ¶ç½‘ç»œå¥—æ¥å­—åˆ›å»ºã€è¿æ¥ã€æ•°æ®å‘é€| 
| IPC / ä¿¡å·é‡	| ipc_permission, sem_associate	| æ§åˆ¶æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€å…±äº«å†…å­˜ç­‰| 
| æ¨¡å—åŠ è½½	| kernel_module_request	| æ§åˆ¶æ¨¡å—åŠ è½½ä¸ç¦æ­¢æŒ‡å®šæ¨¡å—| 
| æŒ‚è½½æ“ä½œ	| sb_mount, sb_umount, sb_remount	| é™åˆ¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ã€å¸è½½ç­‰| 
| å†…å­˜æ“ä½œ	| mmap_file, mmap_addr	| æ§åˆ¶ mmap è¡Œä¸ºï¼Œé˜²æ­¢å¯æ‰§è¡Œæ˜ å°„| 
| è®¾å¤‡æ§åˆ¶	| dev_alloc_name, dev_create	| æ§åˆ¶å­—ç¬¦å—è®¾å¤‡çš„ä½¿ç”¨ä¸å‘½å| 
| ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ	| task_create, task_free	| æ§åˆ¶ä»»åŠ¡åˆ›å»ºå’Œé”€æ¯è¡Œä¸º| 
| BPF/Perf ç›¸å…³	| perf_event_open, bpf	| é™åˆ¶ç”¨æˆ·å¼€å¯ perf/bpf ç¨‹åº| 
| LSM è‡ªå®šä¹‰	| security_add_hooks	| æ’å…¥è‡ªå®šä¹‰ hookï¼ˆç”¨äº eBPF LSMï¼‰| 

### ğŸ§¬ 2. æŒ‰ç…§èµ„æºç»´åº¦åˆ†ç±»çš„å®Œæ•´ LSM Hook è¡¨

| åˆ†ç±»	| Hook ç¤ºä¾‹	| åŠŸèƒ½è¯´æ˜| 
| --| --|- | 
| ğŸ§µ è¿›ç¨‹ç›¸å…³	| bprm_check_security, task_create, task_fix_setuid, task_kill, ptrace_access_check	| æ§åˆ¶ execã€forkã€ä¿¡å·å‘é€ã€ptrace è°ƒè¯•| 
| ğŸ“ æ–‡ä»¶ä¸ inode	| inode_permission, inode_create, file_open, file_ioctl, file_permission, file_mmap	| æ–‡ä»¶æ‰“å¼€ã€åˆ›å»ºã€mmap æ˜ å°„ã€ioctl ä½¿ç”¨| 
| ğŸŒ ç½‘ç»œ	| socket_create, socket_connect, socket_bind, inet_conn_request, inet_csk_clone	| å¥—æ¥å­—åˆ›å»ºã€è¿æ¥ã€ç›‘å¬ç­‰| 
| ğŸ“¦ æŒ‚è½½ä¸è¶…çº§å—	| sb_mount, sb_remount, sb_umount, sb_kern_mount	| æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¡Œä¸ºæ§åˆ¶| 
| ğŸ”— ç¬¦å·é“¾æ¥å’Œè·¯å¾„| path_truncate, path_unlink, path_symlink	| é™åˆ¶è½¯é“¾æ¥ã€åˆ é™¤è¡Œä¸º| 
| ğŸ”§ æ¨¡å—ä¸ç³»ç»Ÿæ§åˆ¶	| kernel_module_request, capable, quotactl, syslog	| æ§åˆ¶å†…æ ¸æ¨¡å—ã€capabilities ä½¿ç”¨| 
| ğŸ“¥ IPC æ§åˆ¶	| ipc_permission, shm_shmat, sem_associate	| æ§åˆ¶ shmã€semã€mq ç­‰ä½¿ç”¨| 
| ğŸ”¬ BPF å’Œ perf	| bpf, perf_event_open, perf_event_write	| é™åˆ¶åŠ è½½ BPF ç¨‹åºã€å¼€å¯ perf events| 
| ğŸ”’ å®‰å…¨ä¸Šä¸‹æ–‡	| cred_prepare, cred_transfer, task_setscheduler	| æ§åˆ¶è¿›ç¨‹èº«ä»½ã€è°ƒåº¦ã€ç”¨æˆ·åˆ‡æ¢| 
| ğŸ—„ï¸ å®‰å…¨å®¡è®¡æ”¯æŒ	| audit_rule_match, audit_rule_free, audit_rule_field	| è§¦å‘å®¡è®¡æ—¥å¿—ä¸è§„åˆ™åŒ¹é…| 
| ğŸ§  LSM åŸºç¡€æ§åˆ¶	| security_add_hooks, init_task_security, cred_alloc_blank	| åˆå§‹åŒ–å®‰å…¨å±æ€§ï¼Œè‡ªå®šä¹‰æ‰©å±•| 

### ğŸ§  3. å„ LSM ä½¿ç”¨çš„å…¸å‹è§„åˆ™ï¼ˆæŒ‰æ¨¡å—ï¼‰
| æ¨¡å—	| å¸¸ç”¨ Hook ç±»å‹	| ç¤ºä¾‹| 
| -|- | -| 
| SELinux	| å‡ ä¹ä½¿ç”¨æ‰€æœ‰ LSM Hookï¼ŒåŸºäºç±»å‹å¼ºåˆ¶è®¿é—®æ§åˆ¶	| inode_permission, bprm_check, socket_create, capable, task_setpgid| 
| AppArmor	| ä¸»è¦åŸºäºè·¯å¾„çš„æ–‡ä»¶è®¿é—®å’Œæ‰§è¡Œæ§åˆ¶	| file_open, bprm_check_security, path_truncate, socket_bind| 
| Smack	| ä½¿ç”¨ç®€åŒ–æ ‡ç­¾ç³»ç»Ÿï¼Œè¾ƒå°‘ hook	| inode_permission, socket_connect, file_open| 
| TOMOYO	| ä½¿ç”¨è·¯å¾„/ç¨‹åºç»„åˆå­¦ä¹ ç­–ç•¥ï¼Œæ–‡ä»¶ä¸è¿›ç¨‹ç±» Hook	| bprm_check_security, file_open, file_ioctl, task_setuid| 
| eBPF LSM	| ç”¨æˆ·å¯é€‰æ‹©æŒ‚è½½ä»»æ„ Hook ç‚¹	| lsm::file_open, lsm::socket_connect, lsm::task_kill ç­‰è‡ªå®šä¹‰å‡½æ•°| 


### ğŸ“Œ æ€»ç»“
| åŠŸèƒ½	| æ¨è Hook| 
|- |- | 
| é˜»æ­¢æŸäº›è¿›ç¨‹è¿è¡Œ	| bprm_check_security| 
| æ§åˆ¶æ–‡ä»¶è¯»å–	| inode_permission, file_open| 
| é˜»æ­¢ç‰¹å®š IP è¿æ¥	| socket_connect| 
| ç¦æ­¢ç”¨æˆ·åŠ è½½æ¨¡å—	| kernel_module_request| 
| æ‹¦æˆª mmap ä¸ºå¯æ‰§è¡Œ	| file_mmap| 
| æ§åˆ¶æŸäº›ä¿¡å·	| task_kill| 



## 04 éœ€è¦ç”Ÿæˆ structçš„ LSM Hook 

### ğŸ§µ è¿›ç¨‹ç±»ï¼ˆå¸¸æ¶‰åŠ task_struct, cred, linux_binprmï¼‰

| Hook åç§°	| å‚æ•°	| å¸¸ç”¨ç›®çš„	| éœ€è¦ç»“æ„ä½“| 
| -|- |- | -| 
| bprm_check_security	| *const linux_binprm	| æ‹¦æˆªè¿›ç¨‹æ‰§è¡Œ	| âœ… linux_binprm| 
| task_kill	| *const task_struct	| ä¿¡å·æ§åˆ¶	| âœ… task_struct| 
| task_fix_setuid	| *const cred	| UID åˆ‡æ¢æ£€æµ‹	| âœ… cred| 
| ptrace_access_check	| *const task_struct	| è°ƒè¯•æƒé™	| âœ… task_struct| 
| task_create	| *const task_struct	| è¿›ç¨‹å…‹éš†/åˆ›å»º	| âœ… task_struct| 

### ğŸ“ æ–‡ä»¶ç±»ï¼ˆæ¶‰åŠ file, dentry, inodeï¼‰
| Hook åç§°	| å‚æ•°	| ç›®çš„	| éœ€è¦ç»“æ„ä½“| 
|- | -|- | -| 
| file_open	| *const file	| æ–‡ä»¶æ‰“å¼€æ‹¦æˆª	| âœ… file, dentry, inode| 
| file_permission	| *const file	| æƒé™æ£€æŸ¥	| âœ… file, cred| 
| inode_permission	| *const inode, *const cred	inode | æƒé™æ£€æŸ¥	| âœ… inode, cred| 
| file_ioctl	| *const file, cmd	| é™åˆ¶æŸäº› ioctl	| âœ… file| 

### ğŸŒ ç½‘ç»œç±»ï¼ˆæ¶‰åŠ sock, sockaddr, socketï¼‰
| Hook åç§°	| å‚æ•°	| ç”¨é€”	| éœ€è¦ç»“æ„ä½“| 
|- | -|- |- | 
| socket_connect	| *mut sock, *const sockaddr	| æ‹¦æˆªè¿æ¥è¯·æ±‚	| âœ… sock, sockaddr| 
| socket_bind	| åŒä¸Š	| é™åˆ¶ç«¯å£ç»‘å®š	| âœ… sock, sockaddr| 
| inet_conn_request	| *mut sock, *mut sk_buff	| å…¥ç«™è¿æ¥è¯·æ±‚	| âœ… sock, sk_buff| 
| socket_create	| int family, int type, int protocol	| æ£€æŸ¥ socket åˆ›å»ºå‚æ•°	| âŒï¼ˆæ— æŒ‡é’ˆå‚æ•°ï¼Œä¸éœ€è¦ structï¼‰| 

### ğŸ§ª æ˜¯å¦ä¸€å®šè¦ç”Ÿæˆç»“æ„ä½“ï¼Ÿ
**ä¸ä¸€å®šï¼š**

- å¦‚æœä½ åªä¾é  UIDã€GIDã€capabilityï¼Œå¯ä»¥ç”¨ helperï¼ˆå¦‚ bpf_get_current_uid_gid()ï¼‰ç›´æ¥è·å–ï¼Œä¸éœ€è¦ç»“æ„ä½“ã€‚

- ä½†å¦‚æœä½ éœ€è¦è®¿é—®ç»“æ„ä½“çš„å­—æ®µï¼ˆå¦‚æ–‡ä»¶è·¯å¾„ã€socket åœ°å€ã€å‘½åç©ºé—´ä¿¡æ¯ç­‰ï¼‰ï¼Œå°±å¿…é¡»é€šè¿‡ aya-tool ç”Ÿæˆå¹¶å®‰å…¨è¯»å–ã€‚

### ğŸ› ï¸ å¦‚ä½•ç”Ÿæˆç»“æ„ä½“ï¼Ÿ
```bash
aya-tool generate \
  --path /sys/kernel/btf/vmlinux \
  --target x86_64 \
  --output src/vmlinux.rs \
  --objects task_struct cred file linux_binprm dentry inode sock sockaddr
```
ä½ å¯ä»¥æ ¹æ®ç”¨åˆ°çš„ hook å‚æ•°é€‰æ‹©æ€§ç”Ÿæˆã€‚

### ğŸ“Œ æ€»ç»“
| ä½¿ç”¨ Hook	| æ˜¯å¦éœ€è¦ç”Ÿæˆç»“æ„ä½“ï¼Ÿ	| ç”Ÿæˆå“ªäº›ï¼Ÿ| 
|- |- |- | 
| bprm_check_security	| âœ…	| linux_binprm| 
| task_kill	| âœ…	| task_struct| 
| file_open	| âœ…	| file, dentry| 
| socket_connect	| âœ…	| sock, sockaddr| 
| socket_create	| âŒ	| æ— ç»“æ„ä½“æŒ‡é’ˆï¼Œä¸å¿…ç”Ÿæˆ| 
| capable	| âŒ	| å¯é€šè¿‡ helper è·å– uidã€capï¼Œæ— éœ€ç»“æ„ä½“| 



## 05 LSM eBPF å¾ˆå¼ºå¤§,ä½†è¿˜éœ€è¦kprobeã€tracepointã€uprobe ç­‰ eBPF ç±»å‹

### ğŸ§  ç»“è®ºå…ˆè¡Œï¼š

**æ˜¯çš„ï¼Œè™½ç„¶ LSM eBPF å¾ˆå¼ºå¤§ï¼Œä½†å®ƒå¹¶ä¸èƒ½è¦†ç›–æ‰€æœ‰å†…æ ¸å¯è§‚æµ‹ç‚¹ã€‚Aya ä¸­è¿˜ä¿ç•™ kprobeã€tracepointã€uprobe ç­‰ eBPF ç±»å‹ï¼Œæ˜¯å› ä¸ºï¼š**

**ğŸ”’ LSM hook ä¸»è¦èšç„¦åœ¨â€œå®‰å…¨å†³ç­–ç‚¹â€ â€”â€” å®‰å…¨ç­–ç•¥ã€è®¿é—®æ§åˆ¶ï¼›è€Œå…¶ä»– eBPF ç±»å‹ï¼ˆkprobeã€tracepointã€XDPã€tc ç­‰ï¼‰èšç„¦åœ¨æ€§èƒ½ç›‘æ§ã€ç½‘ç»œè¿‡æ»¤ã€è¡Œä¸ºè§‚æµ‹ç­‰æ›´å¹¿æ³›ç”¨é€”ã€‚**

### ğŸ” ä¸ºä»€ä¹ˆéœ€è¦å…¶ä»–ç±»å‹çš„ eBPF ç¨‹åºï¼Ÿ
æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹æ¯ç§ç±»å‹çš„ eBPF èƒ½åŠ›å’Œ LSM çš„å±€é™ã€‚

#### ğŸ›¡ï¸ LSM eBPF çš„èƒ½åŠ›ä¸è¾¹ç•Œ
**LSM = Linux Security Module Hook**

**ä¸»è¦èƒ½åŠ›ï¼š**

| åŠŸèƒ½	| ç¤ºä¾‹| 
| -| -| 
| é˜»æ­¢æŸäº›è¡Œä¸ºï¼ˆè¿”å›é 0ï¼‰	| æ‹¦æˆª root execã€å†™æ–‡ä»¶ã€kill ç­‰| 
| æ£€æŸ¥æƒé™	| UIDã€GIDã€CAPã€SELinux labelã€æ–‡ä»¶ inode| 
| å¾®è§‚è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰	| æ‹¦æˆª socket_bindã€file_openã€ptrace ç­‰| 
| æœ€ç»ˆç»“æœå½±å“ç³»ç»Ÿè¡Œä¸º	| æ‹’ç»æŸè¡Œä¸º| 

**LSM çš„å±€é™ï¼š**

| ä¸é€‚åˆçš„åœºæ™¯	| åŸå› | 
|- | -| 
| æ— å®‰å…¨è¯­ä¹‰çš„æ€§èƒ½é‡‡æ ·	| LSM hook ä¸å­˜åœ¨äºè°ƒåº¦å™¨ã€å†…å­˜åˆ†é…è·¯å¾„| 
| ç½‘ç»œåŒ…çš„æ—©æœŸå¤„ç†ï¼ˆXDP å±‚ï¼‰	| LSM hook æ— æ³•æ’å…¥ç½‘å¡é©±åŠ¨å…¥å£| 
| ç”¨æˆ·æ€å‡½æ•°è·Ÿè¸ª	| æ— æ³• hook åˆ°ç”¨æˆ·ç©ºé—´ä»£ç ï¼ˆéœ€è¦ uprobeï¼‰| 
| å†…æ ¸ä»»æ„å‡½æ•°è°ƒç”¨è·Ÿè¸ª	| åªèƒ½ hook LSM æ’æ¡©ç‚¹ï¼Œhook ä¸åˆ°æ™®é€šå‡½æ•°| 
| åŸå§‹äº‹ä»¶è§‚å¯Ÿï¼ˆå¦‚ syscall latencyï¼‰	| æ— ç›´æ¥ hookï¼Œéœ€ä½¿ç”¨ tracepoint/kprobe| 

### ğŸ”© ä¸ºä»€ä¹ˆè¿˜éœ€è¦ kprobeã€tracepointã€uprobeã€XDP ç­‰ï¼Ÿ

| eBPF ç±»å‹	| å¯ hook åœºæ™¯	| ç”¨é€”| 
| -|-| -| 
| kprobe	| ä»»æ„å†…æ ¸å‡½æ•°ï¼ˆå¦‚ do_sys_openat2ï¼‰	| å†…æ ¸å‡½æ•°è¡Œä¸ºè§‚æµ‹ã€åŠ¨æ€åˆ†æ| 
| tracepoint	| å†…æ ¸å®šä¹‰å¥½çš„é™æ€ç‚¹ï¼ˆå¦‚ sched_process_exitï¼‰	| ç¨³å®šè§‚æµ‹ç‚¹ï¼Œæ€§èƒ½ä½å¼€é”€| 
| uprobe	| ä»»æ„ç”¨æˆ·æ€å‡½æ•°ï¼ˆå¦‚ libc ä¸­çš„ mallocï¼‰| 	è¿½è¸ªç”¨æˆ·è¿›ç¨‹è¡Œä¸º| 
| XDP	| ç½‘ç»œé©±åŠ¨å±‚å…¥å£	| é«˜æ€§èƒ½åŒ…è¿‡æ»¤ï¼ˆDDoS é˜²æŠ¤ç­‰ï¼‰| 
| tc	| ç½‘ç»œåè®®æ ˆå±‚	| æ›´ç»†ç²’åº¦åŒ…å¤„ç†| 
| perf_event	| è®¡æ—¶å™¨ / ç¡¬ä»¶äº‹ä»¶	| å‘¨æœŸæ€§é‡‡æ ·ã€æ€§èƒ½åˆ†æ| 
| LSM	| LSM å®‰å…¨æ¥å£ï¼ˆæœ‰é™å‡½æ•°ï¼‰	| å®‰å…¨ç­–ç•¥åˆ¤æ–­ä¸æ‹’ç»æ“ä½œ| 

### ğŸ§ª ç¤ºä¾‹å¯¹æ¯”ï¼šä½ éœ€è¦è°ï¼Ÿ

**âœ… ç›®æ ‡ï¼š**
| ç›®æ ‡	| ç±»å‹| 
| -| -| 
| ç¦æ­¢ | root æ‰§è¡ŒæŸäº›ç¨‹åº	| âœ… LSM| 
| æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹å ç”¨ IO é«˜	| âŒ LSM æ— æ³•ï¼Œéœ€ tracepoint/kprobe| 
| æŠ“å– syscall æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ	| âŒ LSM æ— æ³•ï¼Œéœ€ tracepoint| 
| æ•è·ç”¨æˆ·ç©ºé—´å‡½æ•°å‚æ•°	| âŒ LSM æ— æ³•ï¼Œéœ€ uprobe| 
| æ‹¦æˆªç½‘ç»œåŒ…åœ¨é©±åŠ¨å±‚	| âŒ LSM æ— æ³•ï¼Œéœ€ XDP| 
| åˆ†æ TCP é‡ä¼ 	| âŒ LSM æ— æ³•ï¼Œéœ€ kprobe + sk_buff| 
| è®°å½•æ‰€æœ‰ execve çš„å‘½ä»¤è¡Œ	| âœ… LSM å¯è¯» linux_binprmï¼Œä½†æ€§èƒ½ä¸Š tracepoint ä¹Ÿå¯ä»¥| 

### ğŸ“Œ æ€»ç»“ä¸€å¥è¯ï¼š
**LSM eBPF ç¨‹åºæ˜¯å®‰å…¨æ§åˆ¶çš„ç‹è€…ï¼Œä½†æ— æ³•è§‚å¯Ÿ/åˆ†ææ•´ä¸ªç³»ç»Ÿè¡Œä¸ºã€‚kprobeã€tracepoint ç­‰å…¶ä»–ç±»å‹è®© eBPF æˆä¸ºä¸€æŠŠç³»ç»Ÿå¯è§‚æµ‹æ€§â€œç‘å£«å†›åˆ€â€ã€‚**

